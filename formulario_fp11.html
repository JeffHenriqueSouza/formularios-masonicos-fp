<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FP 11 - Declaração de Regularidade | Federação Portuguesa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="masonic" patternUnits="userSpaceOnUse" width="20" height="20"><path d="M10,2 L18,10 L10,18 L2,10 Z" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23masonic)"/></svg>');
            opacity: 0.1;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .form-content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2c3e50;
            background: white;
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .logo-upload {
            border: 2px dashed #2c3e50;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logo-upload:hover {
            border-color: #34495e;
            background: #ecf0f1;
        }

        .logo-upload.dragover {
            border-color: #2c3e50;
            background: #e8f4fd;
        }

        .signature-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
        }

        .signature-pad-container {
            border: 2px solid #2c3e50;
            border-radius: 8px;
            background: white;
            margin: 10px 0;
        }

        .signature-pad {
            width: 100%;
            height: 150px;
            border-radius: 6px;
        }

        .signature-controls {
            text-align: center;
            margin-top: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .btn-export {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            font-size: 16px;
            padding: 15px 30px;
        }

        .export-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
        }

        .status-section {
            background: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .status-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            scale: 1.2;
        }

        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 10px auto;
            display: block;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .form-content {
                padding: 20px;
            }
        }

        .required {
            color: #e74c3c;
        }

        .info-box {
            background: #e8f6f3;
            border: 1px solid #16a085;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #16a085;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📋 FP 11 - DECLARAÇÃO DE REGULARIDADE</h1>
            <p>Ordem Maçónica Mista Internacional «Le Droit Humain» - Federação Portuguesa</p>
        </div>

        <div class="form-content">
            <form id="fp11Form">
                <!-- Upload do Logótipo -->
                <div class="form-group">
                    <label for="logoUpload">Logótipo da Loja (opcional)</label>
                    <div class="logo-upload" id="logoUpload">
                        <p>📁 Clique ou arraste uma imagem aqui</p>
                        <small>Formatos aceites: JPG, PNG, GIF (máx. 2MB)</small>
                        <input type="file" id="logoFile" accept="image/*" style="display: none;">
                        <img id="logoPreview" class="logo-preview" style="display: none;">
                    </div>
                </div>

                <!-- Dados da Loja -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="loja">Loja <span class="required">*</span></label>
                        <select id="loja" required>
                            <option value="">Selecione a Loja</option>
                            <option value="Loja Acácia Nº 1">Loja Acácia Nº 1</option>
                            <option value="Loja Liberdade Nº 2">Loja Liberdade Nº 2</option>
                            <option value="Loja Fraternidade Nº 3">Loja Fraternidade Nº 3</option>
                            <option value="Loja Igualdade Nº 4">Loja Igualdade Nº 4</option>
                            <option value="Loja Harmonia Nº 5">Loja Harmonia Nº 5</option>
                            <option value="Outra">Outra</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="localData">Local e Data <span class="required">*</span></label>
                        <input type="text" id="localData" required placeholder="Ex: Lisboa, 15 de Janeiro de 2025">
                    </div>
                </div>

                <!-- Dados do Membro -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="nomeMembro">Nome Completo do Membro <span class="required">*</span></label>
                        <input type="text" id="nomeMembro" required placeholder="Nome completo do membro">
                    </div>
                    <div class="form-group">
                        <label for="numeroMembro">Número de Membro</label>
                        <input type="text" id="numeroMembro" placeholder="Número de membro (se aplicável)">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="grauAtual">Grau Maçónico Atual <span class="required">*</span></label>
                        <select id="grauAtual" required>
                            <option value="">Selecione o grau</option>
                            <option value="Aprendiz (1º)">Aprendiz (1º)</option>
                            <option value="Companheiro (2º)">Companheiro (2º)</option>
                            <option value="Mestre (3º)">Mestre (3º)</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dataIniciacaoLoja">Data de Iniciação na Loja</label>
                        <input type="date" id="dataIniciacaoLoja">
                    </div>
                </div>

                <!-- Declaração de Regularidade -->
                <div class="status-section">
                    <h3>Declaração de Regularidade</h3>
                    <p>Declaro que o membro mencionado encontra-se em situação regular perante esta Loja:</p>
                    
                    <div class="status-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="statusCotizacoes" name="regularidade">
                            <label for="statusCotizacoes">Cotizações em dia (Art. 9º)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="statusAssiduo" name="regularidade">
                            <label for="statusAssiduo">Assíduo aos trabalhos (Art. 56º)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="statusComportamento" name="regularidade">
                            <label for="statusComportamento">Comportamento exemplar (Art. 57º)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="statusSuspensao" name="regularidade">
                            <label for="statusSuspensao">Sem processos disciplinares</label>
                        </div>
                    </div>
                </div>

                <!-- Observações -->
                <div class="form-group">
                    <label for="observacoes">Observações Adicionais</label>
                    <textarea id="observacoes" placeholder="Observações adicionais sobre a regularidade do membro (opcional)"></textarea>
                </div>

                <!-- Informações de Contato -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="nomeVM">Nome do V∴M∴ <span class="required">*</span></label>
                        <input type="text" id="nomeVM" required placeholder="Nome completo do Venerável Mestre">
                    </div>
                    <div class="form-group">
                        <label for="emailVM">Email do V∴M∴</label>
                        <input type="email" id="emailVM" placeholder="email@exemplo.com">
                    </div>
                </div>

                <!-- Artigos de Referência -->
                <div class="info-box">
                    <h4>📖 Artigos de Referência</h4>
                    <p><strong>Art. 9º</strong> - Obrigações financeiras dos membros</p>
                    <p><strong>Art. 56º</strong> - Assiduidade aos trabalhos</p>
                    <p><strong>Art. 57º</strong> - Conduta maçónica</p>
                </div>

                <!-- Assinatura Digital -->
                <div class="signature-section">
                    <h3>Assinatura Digital do V∴M∴</h3>
                    <p>Assine no espaço abaixo para validar a declaração:</p>
                    <div class="signature-pad-container">
                        <canvas class="signature-pad" id="signaturePad"></canvas>
                    </div>
                    <div class="signature-controls">
                        <button type="button" class="btn btn-secondary" onclick="clearSignature()">🗑️ Limpar</button>
                    </div>
                </div>

                <!-- Exportação -->
                <div class="export-section">
                    <h3>💾 Exportar Declaração</h3>
                    <p>Escolha o formato de exportação desejado:</p>
                    <button type="button" class="btn btn-export" onclick="exportToWord()">📄 Exportar para Word</button>
                    <button type="button" class="btn btn-export" onclick="exportToPDF()">📋 Exportar para PDF</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Inicializar Signature Pad
        const canvas = document.getElementById('signaturePad');
        const signaturePad = new SignaturePad(canvas);

        // Redimensionar canvas
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }

        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        // Limpar assinatura
        function clearSignature() {
            signaturePad.clear();
        }

        // Upload de logótipo
        const logoUpload = document.getElementById('logoUpload');
        const logoFile = document.getElementById('logoFile');
        const logoPreview = document.getElementById('logoPreview');

        logoUpload.addEventListener('click', () => logoFile.click());
        
        logoUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            logoUpload.classList.add('dragover');
        });

        logoUpload.addEventListener('dragleave', () => {
            logoUpload.classList.remove('dragover');
        });

        logoUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            logoUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleLogoFile(files[0]);
            }
        });

        logoFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleLogoFile(e.target.files[0]);
            }
        });

        function handleLogoFile(file) {
            if (file.type.startsWith('image/') && file.size <= 2 * 1024 * 1024) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    logoPreview.src = e.target.result;
                    logoPreview.style.display = 'block';
                    logoUpload.innerHTML = `
                        <img src="${e.target.result}" class="logo-preview">
                        <p>✅ Logótipo carregado</p>
                        <small>Clique para alterar</small>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                alert('Por favor, selecione uma imagem válida (máx. 2MB).');
            }
        }

        // Validação de formulário
        function validateForm() {
            const required = document.querySelectorAll('[required]');
            let valid = true;

            required.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#e74c3c';
                    valid = false;
                } else {
                    field.style.borderColor = '#ecf0f1';
                }
            });

            if (signaturePad.isEmpty()) {
                alert('Por favor, assine a declaração.');
                valid = false;
            }

            const regularidadeChecks = document.querySelectorAll('input[name="regularidade"]:checked');
            if (regularidadeChecks.length === 0) {
                alert('Por favor, marque pelo menos um item de regularidade.');
                valid = false;
            }

            return valid;
        }

        // Exportar para Word
        async function exportToWord() {
            if (!validateForm()) return;

            const { Document, Paragraph, TextRun, ImageRun, AlignmentType, HeadingLevel } = docx;

            const doc = new Document({
                sections: [{
                    properties: {},
                    children: [
                        new Paragraph({
                            text: "DECLARAÇÃO DE REGULARIDADE",
                            heading: HeadingLevel.TITLE,
                            alignment: AlignmentType.CENTER,
                        }),
                        new Paragraph({
                            text: "Ordem Maçónica Mista Internacional «Le Droit Humain» - Federação Portuguesa",
                            alignment: AlignmentType.CENTER,
                            spacing: { after: 400 }
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Loja: ", bold: true }),
                                new TextRun(document.getElementById('loja').value)
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Local e Data: ", bold: true }),
                                new TextRun(document.getElementById('localData').value)
                            ]
                        }),
                        new Paragraph({
                            text: "",
                            spacing: { after: 200 }
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Nome do Membro: ", bold: true }),
                                new TextRun(document.getElementById('nomeMembro').value)
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Número de Membro: ", bold: true }),
                                new TextRun(document.getElementById('numeroMembro').value || "N/A")
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Grau Maçónico: ", bold: true }),
                                new TextRun(document.getElementById('grauAtual').value)
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Data de Iniciação: ", bold: true }),
                                new TextRun(document.getElementById('dataIniciacaoLoja').value || "N/A")
                            ]
                        }),
                        new Paragraph({
                            text: "",
                            spacing: { after: 200 }
                        }),
                        new Paragraph({
                            text: "DECLARAÇÃO DE REGULARIDADE",
                            heading: HeadingLevel.HEADING_1
                        }),
                        new Paragraph({
                            text: "Declaro que o membro mencionado encontra-se em situação regular perante esta Loja:",
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "☑ Cotizações em dia (Art. 9º): ", bold: true }),
                                new TextRun(document.getElementById('statusCotizacoes').checked ? "SIM" : "NÃO")
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "☑ Assíduo aos trabalhos (Art. 56º): ", bold: true }),
                                new TextRun(document.getElementById('statusAssiduo').checked ? "SIM" : "NÃO")
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "☑ Comportamento exemplar (Art. 57º): ", bold: true }),
                                new TextRun(document.getElementById('statusComportamento').checked ? "SIM" : "NÃO")
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "☑ Sem processos disciplinares: ", bold: true }),
                                new TextRun(document.getElementById('statusSuspensao').checked ? "SIM" : "NÃO")
                            ]
                        }),
                    ]
                }]
            });

            // Adicionar observações se existirem
            const observacoes = document.getElementById('observacoes').value;
            if (observacoes.trim()) {
                doc.addSection({
                    children: [
                        new Paragraph({
                            text: "",
                            spacing: { after: 200 }
                        }),
                        new Paragraph({
                            text: "OBSERVAÇÕES",
                            heading: HeadingLevel.HEADING_2
                        }),
                        new Paragraph({
                            text: observacoes
                        })
                    ]
                });
            }

            // Adicionar informações finais
            doc.addSection({
                children: [
                    new Paragraph({
                        text: "",
                        spacing: { after: 400 }
                    }),
                    new Paragraph({
                        children: [
                            new TextRun({ text: "V∴M∴: ", bold: true }),
                            new TextRun(document.getElementById('nomeVM').value)
                        ]
                    }),
                    new Paragraph({
                        children: [
                            new TextRun({ text: "Email: ", bold: true }),
                            new TextRun(document.getElementById('emailVM').value || "N/A")
                        ]
                    }),
                    new Paragraph({
                        text: "",
                        spacing: { after: 400 }
                    }),
                    new Paragraph({
                        text: "Assinatura: _________________________",
                        alignment: AlignmentType.CENTER
                    })
                ]
            });

            const blob = await docx.Packer.toBlob(doc);
            const fileName = `FP11_Declaracao_Regularidade_${document.getElementById('nomeMembro').value.replace(/\s+/g, '_')}.docx`;
            saveAs(blob, fileName);
        }

        // Exportar para PDF
        async function exportToPDF() {
            if (!validateForm()) return;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            // Configurações
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 20;
            let currentY = 30;

            // Função para adicionar quebra de página se necessário
            function checkPageBreak(pdf, currentY, lineHeight = 10) {
                if (currentY + lineHeight > pdf.internal.pageSize.getHeight() - 20) {
                    pdf.addPage();
                    return 30;
                }
                return currentY;
            }

            // Cabeçalho
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('DECLARAÇÃO DE REGULARIDADE', pageWidth / 2, currentY, { align: 'center' });
            currentY += 10;

            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            pdf.text('Ordem Maçónica Mista Internacional «Le Droit Humain»', pageWidth / 2, currentY, { align: 'center' });
            currentY += 6;
            pdf.text('Federação Portuguesa', pageWidth / 2, currentY, { align: 'center' });
            currentY += 20;

            // Logótipo se existir
            const logoPreview = document.getElementById('logoPreview');
            if (logoPreview.style.display !== 'none' && logoPreview.src) {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const logoData = canvas.toDataURL('image/png');
                        pdf.addImage(logoData, 'PNG', margin, currentY, 40, 20);
                    };
                    img.src = logoPreview.src;
                    currentY += 25;
                } catch (e) {
                    console.log('Erro ao adicionar logótipo:', e);
                }
            }

            currentY = checkPageBreak(pdf, currentY);

            // Dados da Loja
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('DADOS DA LOJA', margin, currentY);
            currentY += 10;

            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Loja: ${document.getElementById('loja').value}`, margin, currentY);
            currentY += 6;
            pdf.text(`Local e Data: ${document.getElementById('localData').value}`, margin, currentY);
            currentY += 15;

            currentY = checkPageBreak(pdf, currentY);

            // Dados do Membro
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('DADOS DO MEMBRO', margin, currentY);
            currentY += 10;

            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Nome: ${document.getElementById('nomeMembro').value}`, margin, currentY);
            currentY += 6;
            pdf.text(`Número de Membro: ${document.getElementById('numeroMembro').value || 'N/A'}`, margin, currentY);
            currentY += 6;
            pdf.text(`Grau Maçónico: ${document.getElementById('grauAtual').value}`, margin, currentY);
            currentY += 6;
            pdf.text(`Data de Iniciação: ${document.getElementById('dataIniciacaoLoja').value || 'N/A'}`, margin, currentY);
            currentY += 15;

            currentY = checkPageBreak(pdf, currentY);

            // Declaração de Regularidade
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('DECLARAÇÃO DE REGULARIDADE', margin, currentY);
            currentY += 10;

            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            pdf.text('Declaro que o membro mencionado encontra-se em situação regular perante esta Loja:', margin, currentY);
            currentY += 10;

            // Status de regularidade
            const checkBox = document.getElementById('statusCotizacoes').checked ? '☑' : '☐';
            pdf.text(`${checkBox} Cotizações em dia (Art. 9º)`, margin + 5, currentY);
            currentY += 6;

            const checkBox2 = document.getElementById('statusAssiduo').checked ? '☑' : '☐';
            pdf.text(`${checkBox2} Assíduo aos trabalhos (Art. 56º)`, margin + 5, currentY);
            currentY += 6;

            const checkBox3 = document.getElementById('statusComportamento').checked ? '☑' : '☐';
            pdf.text(`${checkBox3} Comportamento exemplar (Art. 57º)`, margin + 5, currentY);
            currentY += 6;

            const checkBox4 = document.getElementById('statusSuspensao').checked ? '☑' : '☐';
            pdf.text(`${checkBox4} Sem processos disciplinares`, margin + 5, currentY);
            currentY += 15;

            // Observações
            const observacoes = document.getElementById('observacoes').value;
            if (observacoes.trim()) {
                currentY = checkPageBreak(pdf, currentY);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('OBSERVAÇÕES', margin, currentY);
                currentY += 10;

                pdf.setFontSize(11);
                pdf.setFont(undefined, 'normal');
                const splitText = pdf.splitTextToSize(observacoes, pageWidth - 2 * margin);
                pdf.text(splitText, margin, currentY);
                currentY += splitText.length * 6 + 10;
            }

            currentY = checkPageBreak(pdf, currentY);

            // Informações finais
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'normal');
            pdf.text(`V∴M∴: ${document.getElementById('nomeVM').value}`, margin, currentY);
            currentY += 6;
            pdf.text(`Email: ${document.getElementById('emailVM').value || 'N/A'}`, margin, currentY);
            currentY += 20;

            // Assinatura
            if (!signaturePad.isEmpty()) {
                const signatureData = signaturePad.toDataURL();
                pdf.addImage(signatureData, 'PNG', margin, currentY, 60, 20);
                currentY += 25;
            }

            pdf.text('Assinatura: _________________________', pageWidth / 2, currentY, { align: 'center' });

            // Salvar PDF
            const fileName = `FP11_Declaracao_Regularidade_${document.getElementById('nomeMembro').value.replace(/\s+/g, '_')}.pdf`;
            pdf.save(fileName);
        }

        // Validação em tempo real
        document.querySelectorAll('input[required], select[required]').forEach(field => {
            field.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.style.borderColor = '#e74c3c';
                } else {
                    this.style.borderColor = '#27ae60';
                }
            });
        });

        // Personalização do campo "Outra" loja
        document.getElementById('loja').addEventListener('change', function() {
            if (this.value === 'Outra') {
                const customLoja = prompt('Digite o nome da Loja:');
                if (customLoja) {
                    const option = new Option(customLoja, customLoja, true, true);
                    this.add(option);
                } else {
                    this.value = '';
                }
            }
        });
    </script>
</body>
</html>